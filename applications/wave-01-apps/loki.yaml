# yaml-language-server: $schema=https://json.schemastore.org/yamllint.json

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki
  namespace: argocd
  labels:
    wave: "01"
  annotations:
    argocd.argoproj.io/sync-wave: "01"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: observability
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
  source:
    chart: loki
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 6.41.1
    helm:
      values: |
        loki:
          enabled: true
          
          persistence:
            enabled: false
          
          compactor:
            enabled: true
            retention_enabled: true
            working_directory: /var/loki/compactor

          # 1. CRITICAL: Define storage keys for Helm template helpers
          storage:
            type: s3
            bucketNames:
              chunks: loki-logs 
              ruler: loki-ruler
              admin: loki-admin
            
          # 2. CRITICAL: Define the core Loki config block as a map under the 'config' key
          config:
            limits_config:
              retention_period: 2160h # 90d

            schema_config: # This section satisfies the validation and config map
              configs:
              - from: 2020-10-24
                store: tsdb 
                object_store: s3
                schema: v12
                index:
                  prefix: index_
                  period: 24h

            storage_config:
              tsdb:
                dir: /var/loki/tsdb
              
            # The 'aws' block MUST be defined as part of the config file
            aws: 
              endpoint: minio.minio.svc.cluster.local:9000
              region: us-east-1
              bucketnames: loki-logs
              insecure: true
              access_key_id: admin
              secret_access_key: admin1234
            
        # Disable Promtail and Gateway as planned
        promtail:
          enabled: false
        gateway:
          enabled: false
